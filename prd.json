{
  "projectName": "Media Concierge Bot",
  "description": "Telegram-бот для поиска и скачивания фильмов/сериалов с интеграцией торрент-трекеров, сервисов синхронизации просмотренного и seedbox",
  "version": "1.0.0",
  "targetPlatform": "Koyeb",
  
  "techStack": {
    "language": "Python 3.11+",
    "framework": "python-telegram-bot 21.x (async)",
    "ai": "Anthropic Claude API (claude-sonnet-4-5-20250929)",
    "database": "SQLite (user profiles) + JSON files (cache)",
    "deployment": "Koyeb (Docker)"
  },

  "envVariables": [
    "TELEGRAM_BOT_TOKEN",
    "ANTHROPIC_API_KEY",
    "TMDB_API_KEY",
    "KINOPOISK_API_TOKEN",
    "SEEDBOX_HOST",
    "SEEDBOX_USER",
    "SEEDBOX_PASSWORD",
    "ENCRYPTION_KEY"
  ],

  "userStories": [
    {
      "id": "INFRA-001",
      "category": "infrastructure",
      "priority": 1,
      "title": "Project Structure Setup",
      "description": "Создать базовую структуру проекта с правильной организацией модулей",
      "acceptanceCriteria": [
        "Создана структура директорий: src/, tests/, data/, docs/",
        "Создан pyproject.toml с зависимостями",
        "Создан .env.example с перечнем переменных",
        "Создан .gitignore для Python проекта",
        "Создан Dockerfile для Koyeb",
        "Создан README.md с описанием проекта"
      ],
      "verificationSteps": [
        "ls -la показывает все директории",
        "cat pyproject.toml содержит все зависимости",
        "docker build . проходит без ошибок"
      ],
      "passes": true
    },
    {
      "id": "INFRA-002",
      "category": "infrastructure",
      "priority": 2,
      "title": "Configuration Management",
      "description": "Создать систему конфигурации с загрузкой из .env и валидацией",
      "acceptanceCriteria": [
        "Создан src/config.py с pydantic-settings",
        "Все env переменные типизированы",
        "Есть валидация обязательных переменных",
        "Чувствительные данные не логируются"
      ],
      "verificationSteps": [
        "python -c 'from src.config import settings' работает",
        "При отсутствии TELEGRAM_BOT_TOKEN выбрасывается понятная ошибка"
      ],
      "passes": true
    },
    {
      "id": "INFRA-003",
      "category": "infrastructure",
      "priority": 3,
      "title": "Logging Setup",
      "description": "Настроить структурированное логирование для продакшена",
      "acceptanceCriteria": [
        "Создан src/logger.py с настройкой structlog",
        "Логи в JSON формате для Koyeb",
        "Разные уровни для dev/prod",
        "Не логируются токены и пароли"
      ],
      "verificationSteps": [
        "Лог-сообщения выводятся в JSON формате",
        "В логах нет чувствительных данных"
      ],
      "passes": true
    },
    {
      "id": "BOT-001",
      "category": "telegram",
      "priority": 4,
      "title": "Basic Telegram Bot",
      "description": "Создать базового Telegram-бота с обработкой команд /start и /help",
      "acceptanceCriteria": [
        "Создан src/bot/main.py с инициализацией бота",
        "Реализован handler для /start с приветствием",
        "Реализован handler для /help со списком команд",
        "Бот запускается и отвечает на сообщения",
        "Используется webhook mode для продакшена"
      ],
      "verificationSteps": [
        "python -m src.bot.main запускает бота без ошибок",
        "Бот отвечает на /start",
        "Бот отвечает на /help"
      ],
      "passes": false
    },
    {
      "id": "BOT-002",
      "category": "telegram",
      "priority": 5,
      "title": "Message Streaming with sendMessageDraft",
      "description": "Реализовать стриминг ответов Claude через Telegram sendMessageDraft API",
      "acceptanceCriteria": [
        "Создан src/bot/streaming.py с логикой стриминга",
        "Сообщения обновляются по мере генерации",
        "При ошибке стриминга сообщение всё равно отправляется",
        "Typing indicator показывается во время генерации"
      ],
      "verificationSteps": [
        "Отправка длинного запроса показывает постепенное появление текста",
        "При разрыве соединения сообщение сохраняется"
      ],
      "passes": false
    },
    {
      "id": "AI-001",
      "category": "claude",
      "priority": 6,
      "title": "Claude API Integration",
      "description": "Интегрировать Claude API с поддержкой tool_use",
      "acceptanceCriteria": [
        "Создан src/ai/claude_client.py с async клиентом",
        "Реализована потоковая генерация (streaming)",
        "Настроен system prompt для медиа-консьержа",
        "Реализован механизм tool_use для вызова функций"
      ],
      "verificationSteps": [
        "Тест отправки сообщения Claude возвращает ответ",
        "Streaming работает корректно",
        "Tool calls обрабатываются"
      ],
      "passes": false
    },
    {
      "id": "AI-002",
      "category": "claude",
      "priority": 7,
      "title": "Tool Definitions",
      "description": "Определить все tools для Claude API",
      "acceptanceCriteria": [
        "Создан src/ai/tools.py со всеми определениями tools",
        "Tools: rutracker_search, piratebay_search, tmdb_search, tmdb_credits",
        "Tools: get_user_profile, seedbox_download, kinopoisk_search",
        "Каждый tool имеет JSON schema для параметров",
        "Создан tool executor для обработки вызовов"
      ],
      "verificationSteps": [
        "Все tools валидны по JSON Schema",
        "Tool executor корректно маршрутизирует вызовы"
      ],
      "passes": false
    },
    {
      "id": "SEARCH-001",
      "category": "search",
      "priority": 8,
      "title": "Rutracker Search Integration",
      "description": "Реализовать поиск на Rutracker через веб-скрапинг",
      "acceptanceCriteria": [
        "Создан src/search/rutracker.py",
        "Поиск по названию фильма/сериала",
        "Парсинг результатов: название, размер, сиды, magnet",
        "Фильтрация по качеству (1080p, 4K, etc.)",
        "Обработка капчи и блокировок"
      ],
      "verificationSteps": [
        "Поиск 'Dune 2021' возвращает релевантные результаты",
        "Результаты содержат magnet links",
        "При блокировке выбрасывается понятная ошибка"
      ],
      "passes": false
    },
    {
      "id": "SEARCH-002",
      "category": "search",
      "priority": 9,
      "title": "PirateBay Search Integration",
      "description": "Реализовать поиск на PirateBay как fallback",
      "acceptanceCriteria": [
        "Создан src/search/piratebay.py",
        "Поиск через API или скрапинг",
        "Парсинг результатов: название, размер, сиды, magnet",
        "Фильтрация по категории (Video)",
        "Fallback на зеркала при недоступности"
      ],
      "verificationSteps": [
        "Поиск возвращает результаты",
        "Magnet links валидны",
        "При недоступности основного домена используется зеркало"
      ],
      "passes": false
    },
    {
      "id": "MEDIA-001",
      "category": "media",
      "priority": 10,
      "title": "TMDB Integration",
      "description": "Интегрировать TMDB API для метаданных фильмов",
      "acceptanceCriteria": [
        "Создан src/media/tmdb.py с async клиентом",
        "Поиск фильмов и сериалов по названию",
        "Получение детальной информации о фильме",
        "Получение credits (cast & crew)",
        "Получение рекомендаций",
        "Кэширование результатов"
      ],
      "verificationSteps": [
        "Поиск 'Inception' возвращает правильный фильм",
        "Credits содержат режиссёра и актёров",
        "Повторный запрос использует кэш"
      ],
      "passes": false
    },
    {
      "id": "MEDIA-002",
      "category": "media",
      "priority": 11,
      "title": "Kinopoisk Integration",
      "description": "Интегрировать неофициальный Kinopoisk API для русскоязычных данных",
      "acceptanceCriteria": [
        "Создан src/media/kinopoisk.py",
        "Поиск по названию (русскому и английскому)",
        "Получение рейтинга Кинопоиска",
        "Получение описания на русском",
        "Graceful degradation при недоступности API"
      ],
      "verificationSteps": [
        "Поиск 'Брат' возвращает правильный фильм",
        "Рейтинг Кинопоиска присутствует",
        "При ошибке API бот продолжает работать"
      ],
      "passes": false
    },
    {
      "id": "SEEDBOX-001",
      "category": "seedbox",
      "priority": 12,
      "title": "Seedbox Integration",
      "description": "Реализовать отправку торрентов на seedbox через API (код готов, credentials добавляются позже)",
      "optional": true,
      "acceptanceCriteria": [
        "Создан src/seedbox/client.py",
        "Поддержка Transmission/qBittorrent/Deluge API",
        "Отправка magnet link на скачивание",
        "Получение статуса скачивания",
        "Graceful degradation если seedbox не настроен — показывать magnet ссылку"
      ],
      "verificationSteps": [
        "Код компилируется без ошибок",
        "При отсутствии SEEDBOX_HOST бот показывает magnet ссылку пользователю",
        "Unit тесты для seedbox клиента проходят"
      ],
      "passes": false
    },
    {
      "id": "USER-001",
      "category": "user",
      "priority": 13,
      "title": "User Profile Storage",
      "description": "Создать систему хранения профилей пользователей",
      "acceptanceCriteria": [
        "Создан src/user/storage.py с SQLite",
        "Схема: users, credentials, preferences, watched",
        "Шифрование OAuth токенов",
        "CRUD операции для профиля",
        "Миграции базы данных"
      ],
      "verificationSteps": [
        "Создание пользователя работает",
        "Токены хранятся зашифрованными",
        "Миграции применяются корректно"
      ],
      "passes": false
    },
    {
      "id": "ONBOARD-001",
      "category": "onboarding",
      "priority": 14,
      "title": "User Onboarding Flow",
      "description": "Создать полный flow онбординга нового пользователя",
      "acceptanceCriteria": [
        "Приветственное сообщение с inline кнопками",
        "Создание профиля пользователя при /start",
        "Настройка предпочтений (качество видео, язык аудио)",
        "Inline кнопки для быстрой настройки"
      ],
      "verificationSteps": [
        "/start показывает welcome message с кнопками",
        "Профиль создаётся в базе данных",
        "Предпочтения сохраняются"
      ],
      "passes": false
    },
    {
      "id": "CONV-001",
      "category": "conversation",
      "priority": 15,
      "title": "Natural Language Search",
      "description": "Реализовать поиск фильмов через естественный язык",
      "acceptanceCriteria": [
        "Claude понимает запросы типа 'найди Дюну в 4K'",
        "Claude использует tool_use для поиска",
        "Результаты форматируются красиво",
        "Inline кнопки для скачивания"
      ],
      "verificationSteps": [
        "'Хочу посмотреть что-то похожее на Интерстеллар' возвращает рекомендации",
        "'Скачай Дюну' показывает результаты поиска с кнопками"
      ],
      "passes": false
    },
    {
      "id": "CONV-002",
      "category": "conversation",
      "priority": 16,
      "title": "Context-Aware Responses",
      "description": "Реализовать контекстно-зависимые ответы с учётом профиля",
      "acceptanceCriteria": [
        "Claude помнит предпочтения пользователя из профиля",
        "Рекомендации учитывают жанровые предпочтения",
        "Контекст диалога сохраняется в рамках сессии",
        "Качество видео подбирается по предпочтениям"
      ],
      "verificationSteps": [
        "Бот помнит что пользователь любит sci-fi",
        "Поиск учитывает предпочтения качества (1080p/4K)"
      ],
      "passes": false
    },
    {
      "id": "DEPLOY-001",
      "category": "deployment",
      "priority": 17,
      "title": "Koyeb Deployment",
      "description": "Настроить деплой на Koyeb",
      "acceptanceCriteria": [
        "Dockerfile оптимизирован для продакшена",
        "koyeb.yaml с конфигурацией сервиса",
        "Health check endpoint /health",
        "Webhook URL настраивается автоматически",
        "Переменные окружения из Koyeb secrets"
      ],
      "verificationSteps": [
        "docker build создаёт образ < 500MB",
        "/health возвращает 200 OK",
        "Бот работает после деплоя на Koyeb"
      ],
      "passes": false
    },
    {
      "id": "TEST-001",
      "category": "testing",
      "priority": 18,
      "title": "Unit Tests",
      "description": "Написать unit тесты для критичных компонентов",
      "acceptanceCriteria": [
        "Тесты для парсеров Rutracker/PirateBay",
        "Тесты для TMDB клиента",
        "Тесты для user storage",
        "Тесты для tool executor",
        "Coverage > 70%"
      ],
      "verificationSteps": [
        "pytest проходит без ошибок",
        "Coverage report показывает > 70%"
      ],
      "passes": false
    },
    {
      "id": "DOC-001",
      "category": "documentation",
      "priority": 19,
      "title": "Documentation",
      "description": "Написать полную документацию проекта",
      "acceptanceCriteria": [
        "README с quick start",
        "docs/ARCHITECTURE.md с диаграммами",
        "docs/API.md с описанием tools",
        "docs/DEPLOYMENT.md с инструкцией для Koyeb",
        "Inline документация в коде (docstrings)"
      ],
      "verificationSteps": [
        "README содержит инструкции по запуску",
        "Все публичные функции имеют docstrings"
      ],
      "passes": false
    }
  ],

  "completionCriteria": {
    "allStoriesPassing": true,
    "testsGreen": true,
    "dockerBuilds": true,
    "documentationComplete": true
  },

  "notes": [
    "При застревании на задаче > 5 итераций — документировать блокер и перейти к следующей",
    "Каждый коммит должен быть атомарным и проходить линтер",
    "Использовать ruff для линтинга и форматирования",
    "Не хардкодить secrets в коде"
  ]
}
